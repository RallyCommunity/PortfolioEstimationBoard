<!DOCTYPE html>
<html>
<head>
    <title>Portfolio Estimation Board</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Rally.app.portfolioitem.PortfolioEstimationCard",{extend:"Rally.ui.cardboard.Card",alias:"widget.rallyportfolioestimationcard"});
                Ext.define("PortfolioEstimationBoard",{extend:"Rally.app.App",layout:"auto",appName:"Portfolio Estimation Board",hidden:!0,currentTypeRef:void 0,typeParents:void 0,currentParent:void 0,getSettingsFields:function(){return[{name:"type",xtype:"rallycombobox",storeConfig:{model:"TypeDefinition",filters:[Ext.create("Rally.data.QueryFilter",{property:"TypePath",operator:"Contains",value:"PortfolioItem/"})],sorters:{property:"ordinalValue",direction:"Asc"},autoLoad:!1},readyEvent:"ready"}]},items:[{xtype:"container",itemId:"header",cls:"header"},{xtype:"container",itemId:"bodyContainer",width:"100%"}],launch:function(){var store=Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,remoteFilter:!1,filters:[Ext.create("Rally.data.QueryFilter",{property:"TypePath",operator:"Contains",value:"PortfolioItem/"})],model:"TypeDefinition",sorters:{property:"ordinalValue",direction:"Asc"},context:this.getContext().getDataContext(),listeners:{load:this._loadTypes,scope:this}})},_initHeader:function(type){this.down("#header").add([{xtype:"rallybutton",itemId:"parentButton",cls:"button",text:"Parent Filter Disabled",handler:this._openChooserForFilter,disabled:!0,scope:this},{itemId:"clearButton",xtype:"rallybutton",cls:"button",hidden:!0,text:"Remove Filter",handler:this._clearFilter,scope:this},{xtype:"rallyaddnew",itemId:"addnew",recordTypes:[type.get("TypePath")],cls:"add-new",ignoredRequiredFields:["Name"],listeners:{beforerecordadd:function(addNew,options){options.record=type;var record=options.record;record.set("Project",this.getContext().getProject()._ref),this.currentParent&&record.set("Parent",this.currentParent.get("_ref"))},recordadd:function(addNew,result){this.down("#cardboard").addCard(result.record)},scope:this}}])},_showClearButton:function(currentParent){this.currentParent=currentParent;var button=this.down("#clearButton");button.setVisible(!0)},_clearFilter:function(button){button.setVisible(!1),this.currentParent=null,this._loadCardboard()},_manageParentChooserButton:function(){var button=this.down(".rallybutton");this.typeParents[this.currentTypeRef]?(button.setText("Filter By "+this.typeParents[this.currentTypeRef].get("_refObjectName")),button.setDisabled(!1)):(button.setText("Parent Filter Disabled"),button.setDisabled(!0))},_openChooserForFilter:function(){var filters=[],parent=this.typeParents[this.currentTypeRef];parent&&filters.push({property:"PortfolioItemType",value:parent.get("_ref")}),Ext.create("Rally.ui.dialog.ChooserDialog",{artifactTypes:["portfolioitem"],autoShow:!0,title:"Choose "+parent.get("_refObjectName"),storeConfig:{filters:filters},listeners:{artifactChosen:function(selectedRecord){this._showClearButton(selectedRecord),this._loadCardboard()},scope:this}})},_loadTypes:function(store,records){this.typeParents={};var ascRecords=records.concat().reverse();this.currentTypeRef=this.getSetting("type")||records[0].get("_ref");var previousType,currentType;Ext.each(ascRecords,function(type){var ref=type.get("_ref");this.typeParents[ref]=previousType,previousType=type,ref===this.currentTypeRef&&(currentType=type)},this),this.types=records,this._initHeader(currentType),this._loadCardboard()},_loadCardboard:function(){this._manageParentChooserButton(),this._loadStates({success:function(states){var columns=this._createColumns(states);this.setVisible(!0),this._drawCardboard(columns)},scope:this})},_loadStates:function(options){Ext.create("Rally.data.WsapiDataStore",{model:"PreliminaryEstimate",context:this.getContext().getDataContext(),autoLoad:!0,fetch:!0,sorters:[{property:"Value",direction:"ASC"}],listeners:{load:function(store,records){options.success&&options.success.call(options.scope||this,records)}}})},_drawCardboard:function(columns){if(columns){var cardboard=this.down("#cardboard");cardboard&&cardboard.destroy();var filters=[{property:"PortfolioItemType",value:this.currentTypeRef}];this.currentParent&&filters.push({property:"Parent",value:this.currentParent.get("_ref")}),cardboard=Ext.widget("rallycardboard",{types:["PortfolioItem"],itemId:"cardboard",attribute:"PreliminaryEstimate",columns:columns,maxColumnsPerBoard:columns.length,ddGroup:this.currentTypeRef,enableRanking:this.getContext().get("workspace").WorkspaceConfiguration.DragDropRankingEnabled,cardConfig:{xtype:"rallyportfolioestimationcard",showIconMenus:!0},storeConfig:{filters:filters},loadDescription:"Portfolio Estimation Board"}),this.down("#bodyContainer").add(cardboard),Ext.EventManager.onWindowResize(cardboard.resizeAllColumns,cardboard)}else this._showNoColumns()},_showNoColumns:function(){this.add({xtype:"container",cls:"no-type-text",html:"<p>This Type has no states defined.</p>"})},_createColumns:function(states){var columns;if(states.length){var fakeState=states[0].copy();fakeState.set("Name","No Entry"),columns=[{value:null,record:fakeState,displayField:"Name",cardLimit:50,columnHeaderConfig:{fieldToDisplay:"Name",record:fakeState,editable:!1}}],Ext.Array.each(states,function(state){columns.push({xtype:"rallycardboardcolumn",displayField:"Name",value:state.get("_ref"),record:state,columnHeaderConfig:{fieldToDisplay:"Name",record:state,editable:!0}})})}return columns}});

            Rally.launchApp('PortfolioEstimationBoard', {
                name:"Portfolio Estimation Board",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .button {
    float: right;
    margin-left: 10px;
}

.type-combo {
    float: right;
    margin-left: 10px;
}

.add-new {
    float: left;
    margin-left: 10px;
}

.headerControls {
    float: left;
}

.headerControls .x-panel-body {
    border-style: none;
}

.filterItemDisplay {
    float: right;
}

.header {
    margin-top: 10px
}
    </style>
</head>
<body></body>
</html>
